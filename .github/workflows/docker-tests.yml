name: Docker Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  docker-build-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      run: |
        docker build \
          -t poet:test \
          --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
          --build-arg VCS_REF=${{ github.sha }} \
          --build-arg VERSION=${{ github.ref_name }} \
          .

    - name: Test Docker image health
      run: |
        docker run --rm poet:test python -c "
        import sys
        print(f'âœ… Python version: {sys.version}')
        import core, parser, utils, model, graphics
        print('âœ… All PoET modules imported successfully')
        "

    - name: Run pytest inside Docker container
      run: |
        docker run --rm poet:test python -m pytest tests/ -v --tb=short

    - name: Run pytest with coverage inside Docker
      run: |
        docker run --rm poet:test python -m pytest tests/ -v \
          --cov=core --cov=parser --cov=utils --cov=model --cov=graphics \
          --cov-report=term-missing

    - name: Test CLI help command
      run: |
        docker run --rm poet:test python poet.py --help

    - name: Test Docker workspace mounting
      run: |
        # Create test files in temporary directory
        mkdir -p /tmp/poet-test
        echo "EP(ready & confirmed)" > /tmp/poet-test/property.pctl
        
        cat > /tmp/poet-test/trace.json << 'EOF'
        {
          "processes": 2,
          "process_names": ["Client", "Server"],
          "events": [
            ["client_start", ["P1"], ["ready"], [1, 0]],
            ["server_response", ["P2"], ["confirmed"], [0, 1]],
            ["sync_event", ["P1", "P2"], ["ready", "confirmed"], [2, 2]]
          ]
        }
        EOF
        
        # Test basic monitoring with volume mount
        docker run --rm \
          -v /tmp/poet-test:/workspace \
          poet:test \
          python poet.py \
          -p /workspace/property.pctl \
          -t /workspace/trace.json \
          --output-level=experiment

    - name: Test Docker with complex PCTL trace
      run: |
        # Create more complex test scenario
        mkdir -p /tmp/poet-complex
        echo "AH(request -> EP(response))" > /tmp/poet-complex/property.pctl
        
        cat > /tmp/poet-complex/trace.json << 'EOF'
        {
          "processes": 3,
          "process_names": ["Client", "Server", "Database"],
          "events": [
            ["init", ["P1", "P2", "P3"], ["init"], [1, 1, 1]],
            ["client_request", ["P1"], ["request"], [2, 1, 1]],
            ["server_query", ["P2", "P3"], ["query"], [2, 2, 2]],
            ["db_response", ["P3"], ["data"], [2, 2, 3]],
            ["server_response", ["P2", "P1"], ["response"], [3, 3, 3]]
          ]
        }
        EOF
        
        # Run full monitoring with visualization
        docker run --rm \
          -v /tmp/poet-complex:/workspace \
          poet:test \
          python poet.py \
          -p /workspace/property.pctl \
          -t /workspace/trace.json \
          --visual --output-level=default

    - name: Test Docker with max_state output mode
      run: |
        # Test max_state output mode
        mkdir -p /tmp/poet-maxstate
        echo "EP(synchronized)" > /tmp/poet-maxstate/property.pctl
        
        cat > /tmp/poet-maxstate/trace.json << 'EOF'
        {
          "processes": 2,
          "events": [
            ["event_a", ["P1"], ["a"], [1, 0]],
            ["event_b", ["P2"], ["b"], [0, 1]],
            ["sync_ab", ["P1", "P2"], ["synchronized"], [2, 2]]
          ]
        }
        EOF
        
        # Run with max_state mode
        docker run --rm \
          -v /tmp/poet-maxstate:/workspace \
          poet:test \
          python poet.py \
          -p /workspace/property.pctl \
          -t /workspace/trace.json \
          --output-level=max_state

    - name: Test Docker with state reduction
      run: |
        # Test with reduce mode for performance
        mkdir -p /tmp/poet-reduce
        echo "EP(final_state)" > /tmp/poet-reduce/property.pctl
        
        cat > /tmp/poet-reduce/trace.json << 'EOF'
        {
          "processes": 3,
          "events": [
            ["start_p1", ["P1"], ["started"], [1, 0, 0]],
            ["start_p2", ["P2"], ["started"], [0, 1, 0]],
            ["start_p3", ["P3"], ["started"], [0, 0, 1]],
            ["work_p1", ["P1"], ["working"], [2, 0, 0]],
            ["work_p2", ["P2"], ["working"], [0, 2, 0]],
            ["work_p3", ["P3"], ["working"], [0, 0, 2]],
            ["finalize", ["P1", "P2", "P3"], ["final_state"], [3, 3, 3]]
          ]
        }
        EOF
        
        # Run with state reduction
        docker run --rm \
          -v /tmp/poet-reduce:/workspace \
          poet:test \
          python poet.py \
          -p /workspace/property.pctl \
          -t /workspace/trace.json \
          --reduce --output-level=experiment

    - name: Test Docker memory limits
      run: |
        # Test with memory constraints
        docker run --rm --memory=512m \
          poet:test \
          python -c "
        from core.poet_monitor import PoETMonitor
        from utils.config import Config
        config = Config('test.pctl', 'test.json', False, False, 'default')
        print('âœ… Memory-constrained test passed')
        "

    - name: Test Docker environment variables
      run: |
        docker run --rm \
          -e LOG_LEVEL=DEBUG \
          -e PYTHONPATH=/app \
          -e POET_OUTPUT_LEVEL=debug \
          -e POET_WORKSPACE=/workspace \
          poet:test \
          python -c "
        import os
        print('LOG_LEVEL:', os.getenv('LOG_LEVEL'))
        print('PYTHONPATH:', os.getenv('PYTHONPATH'))
        print('POET_OUTPUT_LEVEL:', os.getenv('POET_OUTPUT_LEVEL'))
        print('POET_WORKSPACE:', os.getenv('POET_WORKSPACE'))
        print('âœ… Environment variables test passed')
        "

    - name: Test vector clock functionality in Docker
      run: |
        # Test vector clock processing
        mkdir -p /tmp/poet-vectorclock
        echo "EP(concurrent_event)" > /tmp/poet-vectorclock/property.pctl
        
        cat > /tmp/poet-vectorclock/trace.json << 'EOF'
        {
          "processes": 3,
          "events": [
            ["init", ["P1", "P2", "P3"], ["init"], [1, 1, 1]],
            ["concurrent_a", ["P1"], ["concurrent_event"], [2, 1, 1]],
            ["concurrent_b", ["P2"], ["concurrent_event"], [2, 2, 1]],
            ["sync_point", ["P1", "P2", "P3"], ["sync"], [3, 3, 2]]
          ]
        }
        EOF
        
        # Test vector clock handling
        docker run --rm \
          -v /tmp/poet-vectorclock:/workspace \
          poet:test \
          python poet.py \
          -p /workspace/property.pctl \
          -t /workspace/trace.json \
          --output-level=debug

    - name: Test code style in Docker
      run: |
        docker run --rm poet:test black --check --diff .

    - name: Test Docker logging capabilities
      run: |
        # Test logging to file
        mkdir -p /tmp/poet-logging
        echo "EP(logged)" > /tmp/poet-logging/property.pctl
        
        cat > /tmp/poet-logging/trace.json << 'EOF'
        {
          "processes": 2,
          "events": [
            ["log_event", ["P1"], ["logged"], [1, 0]],
            ["response", ["P2"], ["response"], [0, 1]]
          ]
        }
        EOF
        
        # Test with log file output
        docker run --rm \
          -v /tmp/poet-logging:/workspace \
          poet:test \
          python poet.py \
          -p /workspace/property.pctl \
          -t /workspace/trace.json \
          --log-file=/workspace/poet.log \
          --log-categories=STATE,PCTL,VECTOR_CLOCK
          
        # Verify log file was created
        docker run --rm \
          -v /tmp/poet-logging:/workspace \
          poet:test \
          sh -c "test -f /workspace/poet.log && echo 'âœ… Log file created successfully'"

    - name: Clean up test files
      if: always()
      run: |
        rm -rf /tmp/poet-test /tmp/poet-complex /tmp/poet-maxstate \
               /tmp/poet-reduce /tmp/poet-vectorclock /tmp/poet-logging

    - name: Report Docker test results
      if: always()
      run: |
        echo "ðŸ³ Docker tests completed"
        echo "ðŸ“Š Docker test status: ${{ job.status }}"
        echo "ðŸŽ¯ PoET Docker image test summary:"
        docker images poet:test